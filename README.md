# UIScom To Centrifugo

## 1C-транслятор уведомлений UIScom в канал сервера Centrifugo.

### Конфигурация 1C для Платформы 1С 8.3.20 
- Содержит подсистему **UIScom** со всеми нужными объектами.
- получения внешних POST-запросов от **UIScom** на адрес **<ВнешнийАдрес>/<ИмяБазы>/hs/UIScom/in**
- и отправки сообщений на сервер Centrifugo (настраивается) в Канал оператора.

### Константы:
* Сервер Centrifugo  - адрес в локальной сети <ИмяКомп:8000> или во вне
* API KEY Centrifugo - ключ авторизации "api-key" из файла config.json сервера Centrifugo

### Поля, которые передаются в канал Centrifugo:
* Только для входящих звонков (**"direction"**:"in")
+ **"channel"**: 4 последние цифры от поля "Номер" (virtual_phone_number)
+ **"text"**: "ЗвонящийНомер" (called_phone_number) 
+ **"user"**: "ВызываемыйНомер" (calling_phone_number)

### История звонков
Все уведомления записываются в регистр сведений **"ИсторияЗвонков"**
+ **Период** - дата получения уведомления, 
+ **Входящий** - признак Входяшего / Исходящего звонка - соответствует полю UIScom "direction":("in"=Истина, "out"=Ложь)
+ **ИдСессии** - "call_session_id" - уникальный идентификатор сессии звонка.
+ **Номер** - главное поле оператора "virtual_phone_number" по которому определяется Канал для отправки в Centrifugo.

### Важные поля регистр сведений "ИсторияЗвонков"
+ **ТелоЗапроса** - содержит полный JSON входящего POST-запроса
+ **ИмяСобытия** - "notification_name" это название уведомления, заданное в личном кабинете UIScom,

Настройка Соответствие полей достаточно жесткая и определена 
в общем модуле **UIScomСервер** в функции **ПолучитьСоотвПолей()**

Там же задан признак **ДобавлятьСобытия**
- Если ДобавлятьСобытия=Истина (по умолчанию), то при получении нового уведомления
- Тогда заполняется поле **ВремяНачала** = "Start_time" в виде строки "2016-07-24 23:59:07.863",
- Иначе записывается поле **Период** = "Start_time" для обновления одной и той же записи !!!
------------
При получении уведомления - проверяется наличие предыдущей записи именно по вышеперечисленным полям (измерениям),
+ и добавляются / заменяются данные в новой/старой записи (в зависимости от признака **ДобавлятьСобытия**)

