# UIScom To Centrifugo

## 1C-транслятор уведомлений UIScom в канал сервера Centrifugo.

### Конфигурация 1C для Платформы 1С 8.3.20 
- Содержит подсистему **UIScom** со всеми нужными объектами.
- получения внешних POST-запросов от **UIScom** на адрес **<ВнешнийАдрес>/<ИмяБазы>/hs/UIScom/in**
- и отправки сообщений на сервер Centrifugo (настраивается) в Канал оператора.

### Константы:
* Сервер Centrifugo  - адрес в локальной сети <ИмяКомп:8000> или во вне
* API KEY Centrifugo - ключ авторизации "api-key" из файла config.json сервера Centrifugo

### Поля, которые передаются в канал Centrifugo:
ТОЛЬКО для входящих звонков (при событии: Начало разговора)
+ **"channel"**: "Канал" = "Внутренний номер" (extension_phone_number)
+ **"text"**: "ВызываемыйНомер" (calling_phone_number) 
+ **"user"**: фиксированный пользователь "UIScom"

### История звонков
Все уведомления записываются в регистр сведений **"ИсторияЗвонков"**
+ **ВремяНачала** - заполняется из поле "Start_time" в виде строки "2016-07-24 23:59:07.863",
+ **Входящий** - признак Входяшего / Исходящего звонка - соответствует полю UIScom "direction":("in"=Истина, "out"=Ложь),
+ **ИдСессии** - "call_session_id" - число(12) - уникальный идентификатор сессии звонка,
+ **Номер** - заполняется из поля "virtual_phone_number" 

### Важные поля регистр сведений "ИсторияЗвонков"
+ **Период** - дата и время уведомления или начала звонка (в зависимости от параметра _ДобавлятьСобытия_ см. ниже)
+ **ИмяСобытия** - "notification_name" это название уведомления, заданное в личном кабинете UIScom,
+ **ТелоЗапроса** - содержит полный JSON входящего POST-запроса

Настройка Соответствие всех полей - полям UIScom достаточно жесткая и определена
* в общем модуле **UIScomСервер -> ПолучитьСоотвПолей()**
------------
#### Параметр - ДобавлятьСобытия
Находится в модуле менеджера рег.св."ИсторияЗвонков" в процедуре **СоздатьЗапись()**
Если этот параметр включён(по умолчанию), тогда при получении нового уведомления
- Иначе записывается поле **Период** = "Start_time" для обновления одной и той же записи !!!
------------
При получении уведомления - проверяется наличие предыдущей записи именно по вышеперечисленным полям (измерениям),
+ и добавляются / заменяются данные в новой/старой записи (в зависимости от признака **ДобавлятьСобытия**)

